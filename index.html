<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Symbol Earthquake Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet Map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      font-family: "Inter", system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: #eef1f6;
      color: #222;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, #7c3aed, #4f46e5);
      color: white;
      padding: 1.2rem 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
    }
    header .sub {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-top: 0.4rem;
    }

    /* Aタイプ：カード＋地図 2カラム */
    .main {
      flex: 1;
      display: flex;
      gap: 10px;
      padding: 10px;
      box-sizing: border-box;
    }

    /* 左：カード一覧 */
    .leftPanel {
      width: 55%;
      overflow-y: auto;
      padding-right: 8px;
    }

    /* 右：地図 */
    .rightPanel {
      width: 45%;
    }

    #map {
      width: 100%;
      height: 100%;
      min-height: 600px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }

    /* スマホ時は1カラム */
    @media(max-width: 900px) {
      .main {
        flex-direction: column;
      }
      .leftPanel, .rightPanel {
        width: 100%;
      }
      #map {
        height: 400px;
      }
    }

    .nodeStatus {
      background: #fff;
      border-left: 4px solid #7c3aed;
      padding: 0.7rem 1rem;
      border-radius: 8px;
      margin-bottom: 1.2rem;
      font-size: 0.9rem;
      color: #444;
    }

    .inputCard {
      background: #fff;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 1.2rem;
    }

    input {
      padding: 0.5rem 0.7rem;
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    button {
      background: #4f46e5;
      color: #fff;
      border: none;
      padding: 0.7rem 1.4rem;
      border-radius: 999px;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 600;
      margin-top: 0.7rem;
    }

    .eqCard {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-left: 6px solid #7c3aed;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .eqCard:hover {
      background: #fafaff;
    }

    .eqHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .6rem;
    }
    .eqTime {
      font-size: 1.05rem;
      font-weight: 600;
    }
    .badgeSymbol {
      background: #7c3aed;
      color: white;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 0.72rem;
    }

    .place {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0.2rem 0 0.5rem;
    }

    /* 震度色分け */
    .shindo {
      padding: 2px 5px;
      border-radius: 4px;
      color: #fff;
      font-weight: 700;
    }
    .s10 { background:#d93025; }
    .s20 { background:#ea4335; }
    .s30 { background:#fbbc04; color:#000; }
    .s40 { background:#34a853; }
    .s50 { background:#4285f4; }
    .s60 { background:#673ab7; }

  </style>
</head>

<body>

<header>
  <h1>Symbol Earthquake Viewer</h1>
  <div class="sub">気象庁の地震情報を Symbol ブロックチェーンに刻んだデータを表示</div>
</header>

<div class="main">

  <!-- 左：地震カード一覧 -->
  <div class="leftPanel">

    <div class="nodeStatus" id="nodeInfo">ノード選択中…</div>

    <div class="inputCard">
      <label>対象アドレス</label>
      <input id="addr" value="NADMA4NNPH2E2XMFGJNTKFYJARRH5VTKXAPUJNQ" />
      <button id="load">地震情報を取得</button>
      <div id="status" style="margin-top:6px;font-size:0.85rem;color:#555;"></div>
    </div>

    <div id="list"></div>

  </div>

  <!-- 右：日本地図 -->
  <div class="rightPanel">
    <div id="map"></div>
  </div>

</div>

<script>
// ========== Leaflet 地図初期化 ==========
let map = L.map('map').setView([36.5, 137.5], 5);

// 国土地理院の地図タイル
L.tileLayer(
  "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
  {
    attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
    maxZoom: 18,
    minZoom: 3
  }
).addTo(map);

let markers = [];  // 地震マーカーを保持

// ========== Symbol ノードウォッチ ==========
const NODEWATCH_URL =
  "https://nodewatch.symbol.tools/api/symbol/nodes/peer?only_ssl=true&limit=100&order=random";

let SELECTED_NODE = null;

// HEX → UTF-8
function hexToUtf8(hex) {
  if (!hex) return "";
  if (hex.length % 2) hex = "0" + hex;
  const bytes = new Uint8Array(hex.match(/.{1,2}/g).map(b => parseInt(b,16)));
  try { return new TextDecoder().decode(bytes); } catch { return ""; }
}

function extractMsg(tx) {
  if (!tx.message) return "";
  if (typeof tx.message === "string") return tx.message;
  if (tx.message.payload) return tx.message.payload;
  return "";
}

// JSON 自動修復
function parseEarthquakeJSON(msg) {
  if (!msg) return null;
  let raw = msg.trim();

  // 外側ダブルクォート除去
  if (raw.startsWith('"') && raw.endsWith('"')) {
    raw = raw.slice(1, -1);
  }
  // エスケープ解除
  raw = raw.replace(/\\"/g, '"');
  // 制御文字除去
  raw = raw.replace(/[\u0000-\u001F]+/g, "");

  try { return JSON.parse(raw); }
  catch { return null; }
}

// ノード選択
async function selectBestNode() {
  const info = document.getElementById("nodeInfo");

  try {
    const res = await fetch(NODEWATCH_URL);
    const nodes = await res.json();

    nodes.sort((a,b)=> Number(b.height||0) - Number(a.height||0));
    const best = nodes[0];

    let ep = best.endpoint;
    try {
      const u = new URL(ep);
      u.protocol = "https:";
      ep = u.origin;
    } catch {}

    SELECTED_NODE = ep;
    info.innerHTML = `使用ノード：<b>${ep}</b><br>ブロック高：${best.height}`;
  } catch (e) {
    info.innerHTML = `<span style="color:red;">ノード取得エラー: ${e.message}</span>`;
  }
}

// 地震データ取得
document.getElementById("load").onclick = async () => {
  if (!SELECTED_NODE) {
    alert("ノード選択中です。数秒待ってから再度お試しください。");
    return;
  }

  const list = document.getElementById("list");
  const status = document.getElementById("status");
  list.innerHTML = "";
  status.textContent = "取得中…";

  // 古いマーカー削除
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  const addr = document.getElementById("addr").value.trim();
  const url = `${SELECTED_NODE}/transactions/confirmed?address=${addr}&pageSize=100&order=desc`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    const txs = data.data || [];
    let latestLat = 36.5;
    let latestLon = 137.5;
    let first = true;

    txs.forEach(item => {
      const tx = item.transaction;
      const msg = hexToUtf8(extractMsg(tx));
      const j = parseEarthquakeJSON(msg);

      if (!j || !j.earthquake) return;

      const eq = j.earthquake;
      const issue = j.issue || {};
      const hypo = eq.hypocenter;

      // 最新の地震を地図中央にする用
      if (first) {
        latestLat = hypo.latitude;
        latestLon = hypo.longitude;
        first = false;
      }

      // 震度色
      const s = Number(eq.maxScale);
      let color = "#d93025";
      if (s >= 50) color = "#673ab7";
      else if (s >= 40) color = "#4285f4";
      else if (s >= 30) color = "#fbbc04";
      else if (s >= 20) color = "#ea4335";

      // Leaflet マーカー
      const marker = L.circleMarker(
        [hypo.latitude, hypo.longitude],
        {
          radius: 8,
          fillColor: color,
          color: "#fff",
          weight: 1,
          fillOpacity: 0.9
        }
      ).addTo(map);

      // ポップアップ内容（震度 & 津波情報あり）
      const popupHtml = `
        <b>${hypo.name}</b><br>
        ${eq.time}<br>
        M${hypo.magnitude} / 最大震度 ${eq.maxScale*0.1}<br>
        津波：国内 ${eq.domesticTsunami} / 海外 ${eq.foreignTsunami}<br>
        発表：${issue.time}
      `;
      marker.bindPopup(popupHtml);

      // マーカーをマウスオーバーでポップアップ
      marker.on("mouseover", function () {
        this.openPopup();
      });
      marker.on("mouseout", function () {
        this.closePopup();
      });

      markers.push(marker);

      // カード生成
      const card = document.createElement("div");
      card.className = "eqCard";

      card.innerHTML = `
        <div class="eqHeader">
          <div class="eqTime">${eq.time}</div>
          <div class="badgeSymbol">Symbol Blockchain</div>
        </div>

        <div class="place">${hypo.name}</div>

        経度/緯度：${hypo.longitude}, ${hypo.latitude}<br>
        深さ：${hypo.depth} km<br>
        M${hypo.magnitude}<br>
        最大震度：<span class="shindo s${s}">${eq.maxScale*0.1}</span><br>
        津波：国内 ${eq.domesticTsunami} / 海外 ${eq.foreignTsunami}<br>
        発表：${issue.time} (${issue.type} / ${issue.source})
      `;

      // カードにマウスオーバー → 対応マーカーへ移動 & ポップアップ
      card.addEventListener("mouseover", () => {
        map.setView([hypo.latitude, hypo.longitude], 8, { animate: true });
        marker.openPopup();
      });
      card.addEventListener("mouseout", () => {
        marker.closePopup();
      });

      list.appendChild(card);
    });

    status.textContent = `取得完了：${markers.length} 件（地震データ）`;

    // 地図を最新の地震に移動
    map.setView([latestLat, latestLon], 6);
  } catch (e) {
    status.innerHTML = `<span style="color:red;">エラー: ${e.message}</span>`;
  }
};

// 起動時にノード選択
selectBestNode();
</script>

</body>
</html>
