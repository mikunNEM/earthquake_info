<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Symbol Earthquake Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body {
    font-family: "Inter", system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background: #eef1f6;
    color: #222;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: linear-gradient(135deg, #7c3aed, #4f46e5);
    color: white;
    padding: 1.2rem 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  header h1 { margin: 0; font-size: 1.4rem; font-weight: 600; }
  header .sub { font-size: 0.9rem; opacity: 0.9; margin-top: 0.4rem; }

  .main { flex: 1; display: flex; gap: 10px; padding: 10px; box-sizing: border-box; }
  .leftPanel { width: 55%; overflow-y: auto; padding-right: 8px; }
  .rightPanel {
    width: 45%;
    position: sticky;
    top: 10px;
    height: calc(100vh - 30px);
  }

  #map {
    width: 100%;
    height: 100%;
    min-height: 600px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.15);
  }

  @media(max-width: 900px) {
    .main { flex-direction: column; }
    .leftPanel, .rightPanel { width: 100%; position: static; }
    #map { height: 400px; }
  }

  .nodeStatus {
    background: #fff; border-left: 4px solid #7c3aed;
    padding: 0.7rem 1rem; border-radius: 8px;
    margin-bottom: 1.2rem; font-size: 0.9rem; color: #444;
  }

  .inputCard {
    background: #fff; padding: 1rem; border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 1.2rem;
  }

  button {
    background: #4f46e5; color: #fff; border: none;
    padding: 0.7rem 1.4rem; border-radius: 999px;
    font-size: 0.95rem; cursor: pointer; font-weight: 600; margin-top: 0.7rem;
  }

  .eqCard {
    background: white; border-radius: 12px; padding: 1rem;
    margin-bottom: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-left: 6px solid #7c3aed; cursor: pointer;
    transition: transform .1s ease;
  }
  .eqCard:hover { background: #fafaff; transform: scale(1.01); }

  .eqHeader { display: flex; justify-content: space-between; }
  .eqTime { font-size: 1.05rem; font-weight: 600; }
  .badgeSymbol {
    background: #7c3aed; color: white; padding: 2px 8px;
    border-radius: 6px; font-size: 0.72rem; cursor: pointer;
  }

  .place { font-size: 1.1rem; font-weight: 600; margin: 0.2rem 0 0.5rem; }

  /* ================================
     â˜… ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆå¹ãå‡ºã—ï¼‰å¼·åŒ–ãƒ‡ã‚¶ã‚¤ãƒ³ â˜…
     ================================ */

  .leaflet-popup-content-wrapper {
    background: #ffffff;
    border: 3px solid #7c3aed;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  }

  .leaflet-popup-content {
    font-size: 1rem;
    font-weight: 600;
    color: #222;
    padding: 8px 12px;
  }

  .leaflet-popup-tip {
    background: #ffffff;
    border: 3px solid #7c3aed;
  }

  .leaflet-popup-close-button {
    color: #7c3aed !important;
    font-size: 20px !important;
    top: 4px;
    right: 6px;
  }
</style>

</head>

<body>

<header>
  <h1>Symbol Earthquake Viewer</h1>
  <div class="sub">æ°—è±¡åºã®åœ°éœ‡æƒ…å ±ã‚’ Symbol ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã«åˆ»ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</div>
</header>

<div class="main">

  <div class="leftPanel">
    <div class="nodeStatus" id="nodeInfo">ãƒãƒ¼ãƒ‰é¸æŠä¸­â€¦</div>

    <div class="inputCard">
      <button id="load">åœ°éœ‡æƒ…å ±ã‚’æ›´æ–°</button>
      <div id="status" style="margin-top:6px;font-size:0.85rem;color:#555;"></div>
    </div>

    <div id="list"></div>
  </div>

  <div class="rightPanel">
    <div id="map"></div>
  </div>

</div>

<script>
// ========== Leaflet ==========
let map = L.map('map').setView([36.5, 137.5], 5);
L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png", {
  attribution: "åœ°ç†é™¢ã‚¿ã‚¤ãƒ«", maxZoom: 18, minZoom: 3
}).addTo(map);

let markers = [];

// ========== ãƒãƒ¼ãƒ‰é¸æŠ ==========
const NODEWATCH_URL =
  "https://nodewatch.symbol.tools/api/symbol/nodes/peer?only_ssl=true&limit=100&order=random";

let SELECTED_NODE = null;

async function selectBestNode() {
  const info = document.getElementById("nodeInfo");
  const res = await fetch(NODEWATCH_URL);
  const nodes = await res.json();

  nodes.sort((a,b) => b.height - a.height);

  let ep = new URL(nodes[0].endpoint);
  ep.protocol = "https:";
  SELECTED_NODE = ep.origin;

  info.innerHTML =
    `ä½¿ç”¨ãƒãƒ¼ãƒ‰ï¼š<b>${SELECTED_NODE}</b><br>ãƒ–ãƒ­ãƒƒã‚¯é«˜ï¼š${nodes[0].height}`;
}

// ========== HEX â†’ UTF-8 ==========
function hexToUtf8(hex) {
  if (!hex) return "";
  if (hex.length % 2) hex = "0" + hex;
  return new TextDecoder().decode(
    new Uint8Array(hex.match(/.{1,2}/g).map(x => parseInt(x,16)))
  );
}

function extractMsg(tx) {
  if (!tx.message) return "";
  return tx.message.payload ?? tx.message;
}

function parseEarthquakeJSON(msg) {
  if (!msg) return null;
  let raw = msg.trim();
  if (raw.startsWith('"') && raw.endsWith('"')) raw = raw.slice(1, -1);
  raw = raw.replace(/\\"/g, '"').replace(/[\u0000-\u001F]+/g, "");
  try { return JSON.parse(raw); } catch { return null; }
}

// -------------------------------------------------------------
// éœ‡åº¦åˆ¥ è‰²è¨­å®š
// -------------------------------------------------------------
function getColorByShindo(shindo, isPending) {
  if (isPending) return "#ff66cc"; // æ–°ç€ãƒ»æœªæ‰¿èª

  if (shindo < 3) return "#7c3aed";        // ç´«ï¼šè»½å¾®
  if (shindo < 4) return "#5b21b6";        // é’ç´«
  if (shindo < 5) return "#f97316";        // ã‚ªãƒ¬ãƒ³ã‚¸ï¼šæ³¨æ„
  if (shindo < 6) return "#dc2626";        // èµ¤ï¼šè­¦æˆ’
  return "#b91c1c";                         // æ¿ƒèµ¤ï¼šå¼·ã„æºã‚Œ
}

// ========== REST: åœ°éœ‡ãƒ‡ãƒ¼ã‚¿å–å¾— ==========
async function loadEarthquake() {
  if (!SELECTED_NODE) return;

  const list = document.getElementById("list");
  const status = document.getElementById("status");
  const address = "NADMA4NNPH2E2XMFGJNTKFYJARRH5VTKXAPUJNQ";

  list.innerHTML = "";
  status.textContent = "å–å¾—ä¸­â€¦";

  markers.forEach(m => map.removeLayer(m));
  markers = [];

  const url =
    `${SELECTED_NODE}/transactions/confirmed?address=${address}&pageSize=20&order=desc`;

  const res = await fetch(url);
  const data = await res.json();

  const txs = (data.data || [])
    .sort((a, b) => Number(b.meta.height) - Number(a.meta.height))
    .slice(0, 20);

  let firstLat = 36.5;
  let firstLon = 137.5;
  let first = true;

  txs.forEach(item => {
    const tx = item.transaction;
    const msg = hexToUtf8(extractMsg(tx));
    const j = parseEarthquakeJSON(msg);
    if (!j || !j.earthquake) return;

    const eq = j.earthquake;
    const hypo = eq.hypocenter;

    if (first) {
      firstLat = hypo.latitude;
      firstLon = hypo.longitude;
      first = false;
    }

    addEarthquakeToUI(j, false, item.meta?.hash, false);
  });

  status.textContent = `å–å¾—å®Œäº†ï¼š${txs.length} ä»¶ï¼ˆæœ€æ–°20ä»¶ï¼‰`;
  map.setView([firstLat, firstLon], 6);
}

// ========== åœ°éœ‡è¡¨ç¤ºï¼šãƒãƒ¼ã‚«ãƒ¼ + ãƒªã‚¹ãƒˆ ==========
function addEarthquakeToUI(j, isPending=false, hash=null, insertTop=false) {
  const eq = j.earthquake;
  const hypo = eq.hypocenter;
  const shindo = eq.maxScale * 0.1;

  // â˜… éœ‡åº¦åˆ¥ & æ–°ç€ã”ã¨ã®è‰²æ±ºå®š
  const color = getColorByShindo(shindo, isPending);

  // ---- åœ°å›³ãƒãƒ¼ã‚«ãƒ¼ ----
  const marker = L.circleMarker(
    [hypo.latitude, hypo.longitude],
    { radius: isPending ? 12 : 9, fillColor: color, color: "#fff", fillOpacity: 0.95 }
  ).addTo(map);

  const popupHtml = `
    <b>${hypo.name}</b><br>
    ${eq.time}${isPending ? "<span style='color:#ff0080;'>ï¼ˆæ–°ç€ãƒ»æœªæ‰¿èªï¼‰</span>" : ""}<br>
    <b>M${hypo.magnitude}</b> ãƒ» <b>éœ‡åº¦ ${shindo}</b><br>
    æ·±ã• ${hypo.depth}km<br>
    æ´¥æ³¢ï¼šå›½å†… ${eq.domesticTsunami} / æµ·å¤– ${eq.foreignTsunami}
  `;

  marker.bindPopup(popupHtml);

  // â˜… æ–°ç€ãªã‚‰è‡ªå‹•ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— & é€šçŸ¥
  if (isPending) {
    map.setView([hypo.latitude, hypo.longitude], 7, { animate: true });
    setTimeout(() => marker.openPopup(), 300);

    if (Notification.permission === "granted") {
      new Notification("æ–°ã—ã„åœ°éœ‡ã‚’æ¤œçŸ¥", {
        body: `${hypo.name} / éœ‡åº¦${shindo}`,
      });
    }
  }

  markers.push(marker);

  // ---- ãƒªã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ ----
  const card = document.createElement("div");
  card.className = "eqCard";
  card.style.borderLeftColor = color;

  const explorerLink = hash
    ? `<a class="badgeSymbol" href="https://symbol.fyi/transactions/${hash}" target="_blank">Symbol Explorer</a>`
    : `<span class="badgeSymbol" style="background:#ff66cc;">æ–°ç€</span>`;

  card.innerHTML = `
      <div class="eqHeader">
        <div class="eqTime">${eq.time}${isPending ? "ï¼ˆæ–°ç€ï¼‰" : ""}</div>
        ${explorerLink}
      </div>
      <div class="place">${hypo.name}</div>
      <div style="font-size:0.9rem; color:#444;">
        æ·±ã• ${hypo.depth}kmãƒ»M${hypo.magnitude}ãƒ»éœ‡åº¦ ${shindo}<br>
        æ´¥æ³¢ï¼šå›½å†… ${eq.domesticTsunami} / æµ·å¤– ${eq.foreignTsunami}
      </div>
  `;

  card.onclick = () => {
    map.setView([hypo.latitude, hypo.longitude], 8, { animate: true });
    marker.openPopup();
  };

  const listEl = document.getElementById("list");
  insertTop ? listEl.prepend(card) : listEl.appendChild(card);
}

// ========== WebSocketï¼ˆæœªæ‰¿èªï¼‰ ==========
const ListenerChannelName = {
  unconfirmedAdded: "unconfirmedAdded",
};

let ws = null;
let uid = "";
let funcs = {};

function addCallback(channel, callback) {
  if (!funcs[channel]) funcs[channel] = [];
  funcs[channel].push(callback);
}

function startWebSocket() {
  const wsUrl = SELECTED_NODE.replace("https", "wss") + "/ws";
  console.log("WS connecting:", wsUrl);

  ws = new WebSocket(wsUrl);

  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);

    if (data.uid !== undefined) {
      uid = data.uid;
      subscribeUnconfirmed();
      return;
    }
    if (funcs[data.topic]) funcs[data.topic].forEach(f => f(data.data));
  };

  ws.onclose = () => {
    console.warn("WS closed â†’ reconnecting...");
    uid = "";
    funcs = {};
    setTimeout(startWebSocket, 1500);
  };
}

function subscribeUnconfirmed() {
  const address = "NADMA4NNPH2E2XMFGJNTKFYJARRH5VTKXAPUJNQ";
  const channel = ListenerChannelName.unconfirmedAdded + "/" + address;

  addCallback(channel, (txObj) => {
    const tx = txObj.transaction;
    const msg = hexToUtf8(extractMsg(tx));
    const j = parseEarthquakeJSON(msg);
    if (!j || !j.earthquake) return;

    console.log("ğŸ”¥ æœªæ‰¿èªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³", j);
    addEarthquakeToUI(j, true, null, true);
  });

  ws.send(JSON.stringify({ uid, subscribe: channel }));
}

// ========== åˆæœŸ ==========
window.onload = async () => {

  // ğŸ”” é€šçŸ¥è¨±å¯ã‚’å–å¾—
  if (Notification && Notification.permission === "default") {
    Notification.requestPermission();
  }

  await selectBestNode();
  await loadEarthquake();
  startWebSocket();
};

// ========== æ›´æ–°ãƒœã‚¿ãƒ³ ==========
document.getElementById("load").onclick = () => {
  loadEarthquake();
};
</script>

</body>
</html>
