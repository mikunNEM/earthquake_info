<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Symbol Earthquake Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet Map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      font-family: "Inter", system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: #eef1f6;
      color: #222;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, #7c3aed, #4f46e5);
      color: white;
      padding: 1.2rem 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    header h1 { margin: 0; font-size: 1.4rem; font-weight: 600; }
    header .sub { font-size: 0.9rem; opacity: 0.9; margin-top: 0.4rem; }

    .main {
      flex: 1; display: flex; gap: 10px; padding: 10px; box-sizing: border-box;
    }

    .leftPanel { width: 55%; overflow-y: auto; padding-right: 8px; }
    .rightPanel { width: 45%; }

    #map {
      width: 100%; height: 100%; min-height: 600px;
      border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }

    @media(max-width: 900px) {
      .main { flex-direction: column; }
      .leftPanel, .rightPanel { width: 100%; }
      #map { height: 400px; }
    }

    .nodeStatus {
      background: #fff; border-left: 4px solid #7c3aed;
      padding: 0.7rem 1rem; border-radius: 8px;
      margin-bottom: 1.2rem; font-size: 0.9rem; color: #444;
    }

    .inputCard {
      background: #fff; padding: 1rem; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 1.2rem;
    }

    input {
      padding: 0.5rem 0.7rem; width: 100%;
      border-radius: 8px; border: 1px solid #ccc; font-size: 0.9rem;
    }

    button {
      background: #4f46e5; color: #fff; border: none;
      padding: 0.7rem 1.4rem; border-radius: 999px;
      font-size: 0.95rem; cursor: pointer; font-weight: 600; margin-top: 0.7rem;
    }

    .eqCard {
      background: white; border-radius: 12px; padding: 1rem;
      margin-bottom: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-left: 6px solid #7c3aed; cursor: pointer;
    }
    .eqCard:hover { background: #fafaff; }

    .eqHeader { display: flex; justify-content: space-between; }
    .eqTime { font-size: 1.05rem; font-weight: 600; }
    .badgeSymbol {
      background: #7c3aed; color: white; padding: 2px 8px;
      border-radius: 6px; font-size: 0.72rem; cursor: pointer;
    }

    .place { font-size: 1.1rem; font-weight: 600; margin: 0.2rem 0 0.5rem; }

  </style>
</head>

<body>

<header>
  <h1>Symbol Earthquake Viewer</h1>
  <div class="sub">気象庁の地震情報を Symbol ブロックチェーンに刻んだデータを表示</div>
</header>

<div class="main">

  <div class="leftPanel">
    <div class="nodeStatus" id="nodeInfo">ノード選択中…</div>

    <div class="inputCard">
      <label>対象アドレス</label>
      <input id="addr" value="NADMA4NNPH2E2XMFGJNTKFYJARRH5VTKXAPUJNQ" />
      <button id="load">地震情報を取得</button>
      <div id="status" style="margin-top:6px;font-size:0.85rem;color:#555;"></div>
    </div>

    <div id="list"></div>
  </div>

  <div class="rightPanel">
    <div id="map"></div>
  </div>

</div>

<script>
// ========== Leaflet 地図 ==========
let map = L.map('map').setView([36.5, 137.5], 5);
L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
{
  attribution: "地理院タイル", maxZoom: 18, minZoom: 3
}).addTo(map);

let markers = [];

// ========== ノード選択 ==========
const NODEWATCH_URL =
  "https://nodewatch.symbol.tools/api/symbol/nodes/peer?only_ssl=true&limit=100&order=random";

let SELECTED_NODE = null;

async function selectBestNode() {
  const info = document.getElementById("nodeInfo");

  const res = await fetch(NODEWATCH_URL);
  const nodes = await res.json();

  nodes.sort((a,b) => b.height - a.height);

  let ep = new URL(nodes[0].endpoint);
  ep.protocol = "https:";
  SELECTED_NODE = ep.origin;

  info.innerHTML =
    `使用ノード：<b>${SELECTED_NODE}</b><br>ブロック高：${nodes[0].height}`;
}

// HEX → UTF-8
function hexToUtf8(hex) {
  if (!hex) return "";
  if (hex.length % 2) hex = "0" + hex;
  return new TextDecoder().decode(
    new Uint8Array(hex.match(/.{1,2}/g).map(x => parseInt(x,16)))
  );
}

// メッセージ抽出
function extractMsg(tx) {
  if (!tx.message) return "";
  return tx.message.payload ?? tx.message;
}

// JSON パース補修
function parseEarthquakeJSON(msg) {
  if (!msg) return null;
  let raw = msg.trim();
  if (raw.startsWith('"') && raw.endsWith('"')) raw = raw.slice(1, -1);
  raw = raw.replace(/\\"/g, '"').replace(/[\u0000-\u001F]+/g, "");
  try { return JSON.parse(raw); } catch { return null; }
}

// ========== データ取得 ==========
document.getElementById("load").onclick = async () => {
  if (!SELECTED_NODE) return alert("ノード準備中です");

  const list = document.getElementById("list");
  const status = document.getElementById("status");

  list.innerHTML = "";
  status.textContent = "取得中…";

  markers.forEach(m => map.removeLayer(m));
  markers = [];

  const url =
    `${SELECTED_NODE}/transactions/confirmed?address=${addr.value}&pageSize=20&order=desc`;

  const res = await fetch(url);
  const data = await res.json();
  const txs = (data.data || []).slice(0, 20);

  let firstLat = 36.5;
  let firstLon = 137.5;
  let first = true;

  txs.forEach(item => {
    const tx = item.transaction;
    const msg = hexToUtf8(extractMsg(tx));
    const j = parseEarthquakeJSON(msg);

    if (!j || !j.earthquake) return;

    const eq = j.earthquake;
    const hypo = eq.hypocenter;
    const issue = j.issue ?? {};
    const shindo = eq.maxScale * 0.1;

    if (first) {
      firstLat = hypo.latitude;
      firstLon = hypo.longitude;
      first = false;
    }

    // 震度色
    let color = "#d93025";
    if (shindo >= 6) color = "#673ab7";
    else if (shindo >= 5) color = "#4285f4";
    else if (shindo >= 4) color = "#34a853";
    else if (shindo >= 3) color = "#fbbc04";
    else if (shindo >= 2) color = "#ea4335";

    // ---- マーカー ----
    const marker = L.circleMarker(
      [hypo.latitude, hypo.longitude],
      { radius: 8, fillColor: color, color: "#fff", fillOpacity: 0.9 }
    ).addTo(map);

    marker.bindPopup(`
      <b>${hypo.name}</b><br>
      ${eq.time}<br>
      M${hypo.magnitude} / 最大震度 ${shindo}<br>
      津波：国内 ${eq.domesticTsunami} / 海外 ${eq.foreignTsunami}<br>
      発表：${issue.time}
    `);

    marker.on("mouseover", () => marker.openPopup());
    marker.on("mouseout", () => marker.closePopup());

    markers.push(marker);

    // ---- 1行地震情報 ----
    const lineInfo = [
      `${hypo.longitude} / ${hypo.latitude}`,
      `深さ${hypo.depth}km`,
      `M${hypo.magnitude}`,
      `震度${shindo}`,
      `津波: 国内 ${eq.domesticTsunami} / 海外 ${eq.foreignTsunami}`,
      `発表: ${issue.time} (${issue.type} / ${issue.source})`
    ].join("・");

    // ---- カード ----
    const txHash = item.meta.hash;

    const card = document.createElement("div");
    card.className = "eqCard";

    card.innerHTML = `
      <div class="eqHeader">
        <div class="eqTime">${eq.time}</div>

        <a class="badgeSymbol"
           href="https://symbol.fyi/transactions/${txHash}"
           target="_blank">
           Symbol Explorer
        </a>
      </div>

      <div class="place">${hypo.name}</div>

      <div style="font-size:0.9rem; line-height:1.4; color:#444;">
        ${lineInfo}
      </div>
    `;

    card.onmouseover = () => {
      map.setView([hypo.latitude, hypo.longitude], 8, { animate: true });
      marker.openPopup();
    };
    card.onmouseout = () => marker.closePopup();

    list.appendChild(card);
  });

  status.textContent = `取得完了：${txs.length} 件（最新20件）`;
  map.setView([firstLat, firstLon], 6);
};

// 起動時にノード選択
selectBestNode();
</script>

</body>
</html>
