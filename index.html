<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Symbol Earthquake Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: "Inter", system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: #eef1f6;
      color: #222;
    }

    header {
      background: linear-gradient(135deg, #7c3aed, #4f46e5);
      color: white;
      padding: 1.2rem 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
    }

    header .sub {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-top: 0.4rem;
    }

    .container {
      padding: 1rem;
      max-width: 900px;
      margin: auto;
    }

    .nodeStatus {
      background: #fff;
      border-left: 4px solid #7c3aed;
      padding: 0.7rem 1rem;
      border-radius: 8px;
      margin-bottom: 1.2rem;
      font-size: 0.9rem;
      color: #444;
    }

    .inputCard {
      background: #fff;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }

    label {
      font-size: 0.85rem;
      color: #555;
    }

    input {
      padding: 0.5rem 0.7rem;
      width: 100%;
      margin-top: 0.3rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    button {
      background: #4f46e5;
      color: #fff;
      border: none;
      padding: 0.7rem 1.4rem;
      border-radius: 999px;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 600;
      margin-top: 0.7rem;
    }

    .eqCard {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-left: 6px solid #7c3aed;
      transition: 0.2s;
    }

    .eqCard:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(0,0,0,0.12);
    }

    .eqHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .6rem;
    }

    .eqTime {
      font-size: 1.05rem;
      font-weight: 600;
      color: #333;
    }

    .badgeSymbol {
      background: #7c3aed;
      color: white;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 0.72rem;
    }

    .place {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0.2rem 0 0.5rem;
      color: #333;
    }

    .infoRow {
      font-size: 0.9rem;
      margin: 0.2rem 0;
      color: #444;
    }

    /* 最大震度の色分け */
    .shindo {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 6px;
      color: #fff;
      font-weight: 600;
      margin-left: 4px;
      font-size: 0.85rem;
    }
    .s10 { background:#c53030; }
    .s20 { background:#e53e3e; }
    .s30 { background:#dd6b20; }
    .s40 { background:#d69e2e; }
    .s50 { background:#38a169; }
    .s60 { background:#2b6cb0; }

    .rawArea {
      background: #f9f9fc;
      border-radius: 8px;
      margin-top: 0.7rem;
      padding: 0.5rem;
      font-size: 0.8rem;
      max-height: 3.5rem;
      overflow: hidden;
      font-family: ui-monospace, monospace;
      border: 1px solid #ddd;
      word-break: break-all;
    }

    .toggle {
      font-size: 0.8rem;
      color: #4f46e5;
      text-decoration: underline;
      cursor: pointer;
      margin-top: 0.3rem;
      display: inline-block;
    }
  </style>
</head>


<body>

<header>
  <h1>Symbol Earthquake Viewer</h1>
  <div class="sub">気象庁の地震情報を Symbol ブロックチェーンに刻んだデータを表示</div>
</header>

<div class="container">

  <div class="nodeStatus" id="nodeInfo">ノード選択中…</div>

  <div class="inputCard">
    <label>対象アドレス</label>
    <input id="addr" value="NADMA4NNPH2E2XMFGJNTKFYJARRH5VTKXAPUJNQ" />

    <button id="load">地震情報を取得</button>
    <div id="status" style="margin-top:6px;font-size:0.85rem;color:#555;"></div>
  </div>

  <div id="list"></div>

</div>


<script>

// ========== ノードウォッチ設定 ==========
const NODEWATCH_URL =
  "https://nodewatch.symbol.tools/api/symbol/nodes/peer?only_ssl=true&limit=100&order=random";

let SELECTED_NODE = null;


// ========== Utility: HEX → UTF8 ==========
function hexToUtf8(hex) {
  if (!hex) return "";
  if (hex.length % 2) hex = "0" + hex;
  const bytes = new Uint8Array(hex.match(/.{1,2}/g).map(b => parseInt(b,16)));
  try { return new TextDecoder().decode(bytes); } catch { return ""; }
}

function extractMessage(tx) {
  if (!tx.message) return "";
  if (typeof tx.message === "string") return tx.message;
  if (tx.message.payload) return tx.message.payload;
  return "";
}


// ========== JSON 自動修復パーサー ==========
function parseEarthquakeJSON(msg) {
  if (!msg) return null;

  let raw = msg.trim();

  // 1) 外側のダブルクォートを除去
  if (raw.startsWith('"') && raw.endsWith('"')) {
    raw = raw.slice(1, -1);
  }

  // 2) エスケープされた \" を元の " に戻す
  raw = raw.replace(/\\"/g, '"');

  // 3) 不要な改行や制御文字を除去（壊れていても復元しやすく）
  raw = raw.replace(/[\u0000-\u001F]+/g, "");

  // 4) 最終パース
  try {
    return JSON.parse(raw);
  } catch {
    console.warn("JSONパース失敗:", raw);
    return null;
  }
}


// ========== ノード選択 ==========
async function selectBestNode() {
  const info = document.getElementById("nodeInfo");

  try {
    const res = await fetch(NODEWATCH_URL);
    const nodes = await res.json();

    nodes.sort((a,b)=> Number(b.height||0) - Number(a.height||0));
    const best = nodes[0];

    let ep = best.endpoint;
    try {
      const u = new URL(ep);
      u.protocol = "https:";
      ep = u.origin;
    } catch {}

    SELECTED_NODE = ep;
    info.innerHTML = `
      使用ノード：<b>${SELECTED_NODE}</b><br>
      ブロック高：${best.height}
    `;
  } catch(e) {
    info.innerHTML = `<span class="err">ノード取得エラー: ${e.message}</span>`;
  }
}


// ========== 地震データ取得 ==========
document.getElementById("load").onclick = async () => {

  const status = document.getElementById("status");
  const list = document.getElementById("list");

  if (!SELECTED_NODE) {
    alert("ノードがまだ準備できていません。数秒待ってください。");
    return;
  }

  const addr = document.getElementById("addr").value;
  list.innerHTML = "";
  status.textContent = "取得中…";

  try {
    const url = `${SELECTED_NODE}/transactions/confirmed?address=${addr}&pageSize=100&order=desc`;
    const res = await fetch(url);
    const data = await res.json();

    const txs = data.data || [];
    let count = 0;

    txs.forEach(item => {
      const tx = item.transaction;
      const msg = hexToUtf8(extractMessage(tx));

      const j = parseEarthquakeJSON(msg);
      if (!j || !j.earthquake) return;

      count++;

      const eq = j.earthquake;
      const issue = j.issue || {};

      const shindo = Number(eq.maxScale || 0);
      let shClass = "s10";
      if (shindo >= 50) shClass = "s60";
      else if (shindo >= 40) shClass = "s50";
      else if (shindo >= 30) shClass = "s40";

      const card = document.createElement("div");
      card.className = "eqCard";

      card.innerHTML = `
        <div class="eqHeader">
          <div class="eqTime">${eq.time}</div>
          <div class="badgeSymbol">Symbol Blockchain</div>
        </div>

        <div class="place">${eq.hypocenter.name}</div>

        <div class="infoRow">
          経度/緯度：${eq.hypocenter.longitude}, ${eq.hypocenter.latitude}
        </div>
        <div class="infoRow">
          深さ：${eq.hypocenter.depth} km
        </div>
        <div class="infoRow">
          マグニチュード：${eq.hypocenter.magnitude}
        </div>
        <div class="infoRow">
          最大震度：
          <span class="shindo ${shClass}">${eq.maxScale}</span>
        </div>

        <div class="infoRow">
          津波：国内 ${eq.domesticTsunami} / 海外 ${eq.foreignTsunami}
        </div>

        <div class="infoRow">
          発表：${issue.time} (${issue.type} / ${issue.source})
        </div>

        <div class="rawArea" id="raw_${tx.hash}">
          ${msg.replace(/\n/g, "")}
        </div>
        <span class="toggle" onclick="toggleRaw('${tx.hash}')">全文表示</span>
      `;

      list.appendChild(card);
    });

    status.textContent = `取得完了：${count} 件（地震データ）`;

  } catch(e) {
    status.innerHTML = `<span class="err">エラー: ${e.message}</span>`;
  }
};


// ========== RAW JSON トグル ==========
function toggleRaw(id) {
  const el = document.getElementById(`raw_${id}`);
  if (el.style.maxHeight) {
    el.style.maxHeight = "";
    el.style.overflow = "";
  } else {
    el.style.maxHeight = "3.5rem";
    el.style.overflow = "hidden";
  }
}


// 起動時に最適ノード選択
selectBestNode();

</script>

</body>
</html>

